{% extends 'base.html' %}

{% block title %}{{ date_str }} - TaskFlow{% endblock %}

{% block extra_head %}
<style>
    .time-slot {
        border-bottom: 1px solid #e9ecef;
        padding: 15px 0;
        transition: background-color 0.2s;
    }
    .time-slot:hover {
        background-color: #f8f9fa;
    }
    .time-label {
        font-weight: 600;
        color: #495057;
        min-width: 80px;
    }
    .task-input {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 10px 15px;
        width: 100%;
        transition: all 0.3s;
        background-color: #fff;
    }
    .task-input:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        outline: none;
    }
    .task-input.saved {
        background-color: #d4edda;
        border-color: #c3e6cb;
    }
    .save-status {
        font-size: 0.8rem;
        margin-top: 5px;
        height: 20px;
    }
    .schedule-container {
        max-width: 800px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="schedule-container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="display-6 mb-1">{{ date_str }}</h1>
                <p class="text-muted mb-0">Daily Schedule & Tasks</p>
            </div>
            <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                <i class="fas fa-calendar me-2"></i>Back to Calendar
            </a>
        </div>

        <!-- Schedule Card -->
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Hourly Schedule (4:00 AM - 10:00 PM)
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Time Slots -->
                {% for hour, task in tasks.items %}
                    <div class="time-slot px-4">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <div class="time-label">
                                    {% if hour < 12 %}
                                        {% if hour == 4 %}4:00 AM{% elif hour == 5 %}5:00 AM{% elif hour == 6 %}6:00 AM{% elif hour == 7 %}7:00 AM{% elif hour == 8 %}8:00 AM{% elif hour == 9 %}9:00 AM{% elif hour == 10 %}10:00 AM{% elif hour == 11 %}11:00 AM{% endif %}
                                    {% elif hour == 12 %}
                                        12:00 PM
                                    {% else %}
                                        {% if hour == 13 %}1:00 PM{% elif hour == 14 %}2:00 PM{% elif hour == 15 %}3:00 PM{% elif hour == 16 %}4:00 PM{% elif hour == 17 %}5:00 PM{% elif hour == 18 %}6:00 PM{% elif hour == 19 %}7:00 PM{% elif hour == 20 %}8:00 PM{% elif hour == 21 %}9:00 PM{% elif hour == 22 %}10:00 PM{% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-10">
                                <input 
                                    type="text" 
                                    class="task-input" 
                                    placeholder="Enter your task or appointment..."
                                    value="{{ task.task_text|default:'' }}"
                                    data-task-id="{{ task.id }}"
                                    data-hour="{{ hour }}"
                                >
                                <div class="save-status text-success" style="opacity: 0;">
                                    <i class="fas fa-check me-1"></i>Saved
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Instructions -->
        <div class="alert alert-info mt-4">
            <i class="fas fa-info-circle me-2"></i>
            <strong>How to use:</strong> Click on any time slot and start typing your task. Changes are automatically saved as you type.
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const taskInputs = document.querySelectorAll('.task-input');
    let saveTimeout;

    taskInputs.forEach(input => {
        input.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            
            // Visual feedback - show typing
            this.classList.remove('saved');
            const statusDiv = this.nextElementSibling;
            statusDiv.style.opacity = '0';
            
            // Debounce saving - wait 1 second after user stops typing
            saveTimeout = setTimeout(() => {
                saveTask(this);
            }, 1000);
        });

        input.addEventListener('blur', function() {
            clearTimeout(saveTimeout);
            saveTask(this);
        });
    });

    function saveTask(inputElement) {
        const taskId = inputElement.dataset.taskId;
        const taskText = inputElement.value;
        const statusDiv = inputElement.nextElementSibling;

        // Send AJAX request
        fetch('{% url "save_task" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `task_id=${taskId}&task_text=${encodeURIComponent(taskText)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                inputElement.classList.add('saved');
                statusDiv.style.opacity = '1';
                setTimeout(() => {
                    statusDiv.style.opacity = '0';
                }, 2000);
            }
        })
        .catch(error => {
            console.error('Error saving task:', error);
        });
    }
});
</script>
{% endblock %}